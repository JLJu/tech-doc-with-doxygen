<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>The Software Practitioner: Dynamic DNS with BIND and dhclient</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">The Software Practitioner
   </div>
   <div id="projectbrief">Practicing to make software perfect.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)"
               onblur="searchBox.OnSearchFieldFocus(false)"
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dyn_dns.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0"
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Dynamic DNS with BIND and dhclient </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this blogpost we're going to configure the BIND server to accept dynamic updates. Client machines themselves will send the updates to the DNS server instead of letting DHCP server update the DNS. A great setup for situations where the DHCP server is not in your control.</p>
<p>Examples in this article work on RHEL6 that comes with BIND 9. You'll need to have <code>bind</code> and <code>bind-utils</code> RPM packages installed. In the following, the BIND server with host name <code>ns.somedomain.com</code> is an authoritative DNS server for the fictive zone <code>somedomain.com</code>.</p>
<h1><a class="anchor" id="dyn_dns_bind"></a>
Dynamic DNS with BIND</h1>
<p>In our example we're going to configure the BIND server to accept DNS updates for <code>somedomain.com</code> zone from any client. In production environment you'd use encryption keys to secure the access to the DNS server. You can read more on the secure configuration in <a href="http://linux.yyz.us/nsupdate/" title="nsupdate: Painless Dynamic DNS">this</a> excellent article. To allow any client to update the <code>somedomain.com</code> zone add the <code>allow-update { 0/0; };</code> option into your <code>/etc/named.conf</code> file:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;zone &quot;somedomain.com&quot; in {</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;        type master;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        file &quot;db.somedomain.com&quot;;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;        allow-update { 0/0; };</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;};</div>
</div><!-- fragment --><p>After restarting the DNS server with <code>sudo /etc/init.d/named restart</code> we can test that the DNS updates are working. Let's ask the DNS server <code>ns.somedomain.com</code> to register a host <code>somehost.somedomain.com</code> with IP address <code>192.168.100.200</code>: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;nsupdate -d &lt;&lt; EOF</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;server ns.somedomain.com</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;update add somehost.somedomain.com 300 A 192.168.100.200</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;send</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;EOF</div>
</div><!-- fragment --><p> If everything worked fine you should see <code>status: NOERROR</code> in the reply from update query. The DNS server created a new record in its database pairing the <code>somehost.somedomain.com</code> host name with the IP address <code>192.168.100.200</code>. Let's check that the host name resolution works by issuing: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;host somehost.somedomain.com ns.somedomain.com</div>
</div><!-- fragment --><p> You should see the IP address <code>192.168.100.200</code> in the command output. When on the DNS server you can dump the zone data into <code>/var/named/data/cache_dump.db</code> file for inspection: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;rndc dumpdb -all</div>
</div><!-- fragment --><h1><a class="anchor" id="dyn_nds_update"></a>
Updating DNS after IP acquisition</h1>
<p>Our virtual machines obtain their IP addresses via DHCP. Whenever the virtual machine obtains a new IP address or renews the lease we'd like it to update the DNS accordingly. This way the DNS is always kept up to date and we're able to access the virtual machine using its host name.</p>
<p>The IP address acquisition is managed by the DHCP client <code>dhclient</code> running on the virtual machine. The <code>dhclient</code> can be extended by custom hooks. We are going to prepare a script that updates the DNS database whenever the virtual machine acquires an IP address. Our DNS update hook must be saved at <code>/etc/dhcp/dhclient-eth0-up-hooks</code>. The <code>/sbin/dhclient-script</code> shell script that comes with the <code>dhclient</code> package will execute the hook. Upon execution the hook is passed a <code>reason</code> variable describing the event.</p>
<p>To install the update hook on the virtual machine let's make use of Cloud-Init tool that I talked about in the <a href="/blog/2015/04/26/using-cloud-init-outside-of-cloud/" title="Using Cloud-Init Outside of Cloud">previous blogpost</a>. The cloud-config script to be consumed by Cloud-Init looks as follows:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;#cloud-config</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;fqdn: somehost.somedomain.com</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;write_files:</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  - path: /etc/dhcp/dhclient-eth0-up-hooks</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    permissions: &#39;0755&#39;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    content: |</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      #!/bin/bash</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;      INTERFACE=eth0</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;      LEASE_FILE=/var/lib/dhclient/dhclient-$INTERFACE.leases</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;      HOST_ADDR=$(sed -n -e &#39;s/.*fixed-address \([0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p&#39; $LEASE_FILE | tail -1)</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;      HOST_NAME=$(hostname)</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;      NAMESERVER=ns.somedomain.com</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;      TTL=300</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      if host $NAMESERVER 1&gt;/dev/null 2&gt;&amp;1; then</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        case $reason in</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;          BOUND|RENEW|REBIND|REBOOT)</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;            nsupdate &lt;&lt; EOF</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;              server $NAMESERVER</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;              update delete $HOST_NAME A</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;              update add $HOST_NAME $TTL A $HOST_ADDR</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;              send</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;      EOF</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;          ;;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        esac</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;      fi</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;runcmd:</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  - hostname somehost.somedomain.com # fix the hostname incorrectly set up by cloud-init</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  - reason=BOUND /etc/dhcp/dhclient-eth0-up-hooks # DNS registration on first boot</div>
</div><!-- fragment --><p>Upon the very first execution of the hook the machine's network setup is not complete yet. There's no <code>/etc/resolv.conf</code> file written yet and the default route is not configured. The condition <code>if host $NAMESERVER; then ...</code> skips the DNS update in this case. Later in the initialization process the <code>runcmd</code> part of the cloud-config script gets executed. At this time the network configuration is complete and so we execute the update hook manually. This is the first time that the virtual machine registers itself with DNS. Cloud-Init executes the <code>runcmd</code> section only on the very first boot. Subsequent boots won't execute the <code>runcmd</code> code.</p>
<p>Note that we're parsing the <code>/var/lib/dhclient/dhclient-eth0.leases</code> file to obtain the acquired IP address. Should the virtual machine obtain different IP address in the future the DNS entry gets updated accordingly. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Jun 14 2015 23:14:41 for The Software Practitioner by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
