<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>The Software Practitioner: Using Cloud-Init Outside of Cloud</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">The Software Practitioner
   </div>
   <div id="projectbrief">Practicing to make software perfect.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)"
               onblur="searchBox.OnSearchFieldFocus(false)"
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('cloud_init.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0"
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using Cloud-Init Outside of Cloud </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In EC2 and OpenStack cloud environments <em>user data</em> can be passed to the cloud instance to customize the cloud instance on the first boot. But what if your virtual machine doesn't run in the cloud environment? In this article we're going to configure our virtual machines with user data regardless if they're running in the cloud or not.</p>
<h1><a class="anchor" id="cloud_init_intro"></a>
Introducing Cloud-Init</h1>
<p><a href="https://cloudinit.readthedocs.org/en/latest/" title="Cloud-Init documentation">Cloud-Init</a> is a tool that handles early initialization of a cloud instance. The <code>cloud-init</code> RPM package should be installed on the disk image which the cloud instance is going to boot up from. The package installs init scripts into <code>/etc/rc.d/init.d</code> that makes Cloud-Init run early during the system initialization. Cloud-Init obtains user data passed to it by the cloud software and executes them. User data contains a set of configuration tasks for the cloud instance. For example, Cloud-Init can update machine's hostname, configure <code>/etc/hosts</code>, create users, configure SSH authorized keys, resize filesystems, manage disk mounts, run user-defined scripts and <a href="https://cloudinit.readthedocs.org/en/latest/topics/examples.html" title="Cloud config examples">much more</a>.</p>
<blockquote class="doxtable">
<p>Even if you're not running your virtual machines in the cloud environment it's worth it to deploy Clout-Init. </p>
</blockquote>
<p>Every cloud software comes with its own mechanism of how to pass the user data to the cloud instance. For example, EC2 provides a <em>magic IP</em> from which the instance can download its user data. OpenStack cloud attaches a special <em>config drive</em> to the cloud instance containing the user data to be consumed by Clout-Init. In order to pass the user data to our virtual machine let's go the OpenStack way and assemble a minimum config drive.</p>
<h1><a class="anchor" id="cloud_init_drive"></a>
Config drive assembly</h1>
<p>First, we're going to prepare the following file structure for our config drive:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;config_drive</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;config_drive/openstack</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;config_drive/openstack/latest</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;config_drive/openstack/2012-08-10</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;config_drive/openstack/2012-08-10/meta_data.json</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;config_drive/openstack/2012-08-10/user_data</div>
</div><!-- fragment --><p>Start by creating directories and the <code>latest</code> symbolic link like this:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;mkdir config_drive</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;mkdir -p config_drive/openstack/2012-08-10</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;ln -s 2012-08-10 config_drive/openstack/latest</div>
</div><!-- fragment --><p>Next create a minimum metadata file required by Cloud-Init. I'm using a fully qualified domain name of the virtual machine as its UUID:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cat &gt; config_drive/openstack/latest/meta_data.json &lt;&lt; EOF</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;{</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    &quot;uuid&quot;: &quot;myinstance.mydomain.com&quot;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;}</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;EOF</div>
</div><!-- fragment --><p>Cloud-Init supports many <a href="https://cloudinit.readthedocs.org/en/latest/topics/format.html" title="Cloud-Init user data formats">formats</a> for scripts within user data. One of the most popular formats is the <em>cloud-config</em> file format. Let's create a cloud-config script that adds our SSH public key to the authorized keys for the user <code>root</code> on the virtual machine. We can then login into the virtual machine as user root without using a password. If you don't have a public-private SSH key pair you can quickly generate it using <code>ssh-keygen</code> command:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;ssh-keygen -f mykey</div>
</div><!-- fragment --><p>Now create a <code>user_data</code> file with the configuration instructions for Cloud-Init. In the following code block replace the value of the <code>ssh-authorized-keys</code> field with the content of your generated <code>mykey.pub</code> file:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cat &gt; config_drive/openstack/latest/user_data &lt;&lt; EOF</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;#cloud-config</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;fqdn: myinstance.mydomain.com</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;users:</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  - name: root</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    ssh-authorized-keys:</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNH8Qwn4raGR1f9fvjbZe/GXM2N9Mh+eWlsFoYpcU4H5qf5YxT5CUo7BaTOgeE5geHyzxJQmCQlvoxcW3qkcjBJvVgEsTrrnX7KYS8BszvT4AMIuG2Za8f7myubXd6zYfj74XYhutUsPz7x2TEp9ZqbVkWcaElrQFxF2AzF7dV1RGntpPKyISqem70En8RYpGY514OLZ9TQDBYjbw8tfPuDd9mznXnWOZ34fPtP7+QDvOMFuA4tXsBpHj99/cbC0ViwzZtvb1QtY7dv9OFDgCRadw81+SKtzXctQ2rCYkb0huc0BCE7kLzinzlO62Znd+N1d+tpLAwP6i8Z5ZMXIJj user@machine</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;EOF</div>
</div><!-- fragment --><p>The file structure for our config drive is ready. Let's generate an ext2 filesystem and copy the files to it. The <code>virt-make-fs</code> utility from the <code>libguestfs-tools</code> package can help us with that:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;virt-make-fs config_drive disk.config</div>
</div><!-- fragment --><p>In order for Cloud-Init to detect the attached drive as config drive the filesystem on the config drive needs to be labeled <code>config-2</code>. You can use <code>e2label</code> command from the <code>e2fsprogs</code> package to label your config drive: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;e2label disk.config config-2</div>
</div><!-- fragment --><h1><a class="anchor" id="cloud_init_action"></a>
Cloud-Init in action</h1>
<p>On my Linux host I'm running <a href="http://libvirt.org/" title="Libvirt - The virtualization API">libvirt</a> to ease the management of virtual machines. You can install it by running <code>sudo yum install libvirt</code>. There is a handy command-line utility <code>virsh</code> which comes with libvirt in the extra package <code>libvirt-client</code>.</p>
<p>Let's create a virtual machine with the config drive attached. As a virtual machine boot image I'm using a CentOS-6 image from <a href="http://cloud.centos.org/centos/6/images/" title="CentOS-6 cloud images">cloud.centos.org</a> which comes with Cloud-Init built in. Make sure that your virtual machine boot image has Cloud-Init installed. Following is a virtual machine definition file for the CentoOS-6 virtual machine. You might need to change the location of the disk image files and save it as <code>CentOS-6.xml</code>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;domain type=&#39;kvm&#39;&gt;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &lt;name&gt;CentOS-6&lt;/name&gt;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &lt;memory unit=&#39;KiB&#39;&gt;2097152&lt;/memory&gt;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  &lt;os&gt;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    &lt;type&gt;hvm&lt;/type&gt;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  &lt;/os&gt;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  &lt;devices&gt;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;      &lt;driver name=&quot;qemu&quot; type=&quot;qcow2&quot;/&gt;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;      &lt;source file=&#39;/tmp/CentOS-6-x86_64-GenericCloud.qcow2&#39;/&gt;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;      &lt;target bus=&quot;virtio&quot; dev=&quot;vda&quot;/&gt;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    &lt;/disk&gt;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;      &lt;driver name=&quot;qemu&quot; type=&quot;raw&quot;/&gt;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      &lt;source file=&#39;/tmp/disk.config&#39;/&gt;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;      &lt;target bus=&quot;virtio&quot; dev=&quot;vdb&quot;/&gt;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    &lt;/disk&gt;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    &lt;interface type=&#39;network&#39;&gt;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      &lt;source network=&#39;default&#39;/&gt;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    &lt;/interface&gt;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    &lt;serial type=&quot;file&quot;&gt;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;      &lt;source path=&quot;/tmp/CentOS-6.log&quot;/&gt;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    &lt;/serial&gt;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  &lt;/devices&gt;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;&lt;/domain&gt;</div>
</div><!-- fragment --><p>Okay, everything is ready, let's launch our Cloud-Init enabled CentOS-6 virtual machine: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;sudo virsh define CentOS-6.xml</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;sudo virsh start CentOS-6</div>
</div><!-- fragment --><p> If everything went fine you can watch the console output of the booting virtual machine at <code>/tmp/CentOS-6.log</code>. Cloud-Init will print out the IP address obtained by the virtual machine (192.168.122.165 in my case) where we can login as root using the generated private key: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;ssh -i testkey root@192.168.122.165</div>
</div><!-- fragment --><p> Congratulations, your virtual machine has just been configured by Cloud-Init the same way as any other virtual machine running in the cloud environment. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Jun 14 2015 23:14:41 for The Software Practitioner by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
